#!/bin/bash

function download_packages() {
   mkdir -p Bootstrap
   rsync --verbose --progress --port=8730 -r -L rsync.gobolinux.org::chrootcompile-packages/ Bootstrap/
}

function update_tools() {
    [ "$quiet" ] && echo "Fetching the ChrootCompile module from CVS..."
    cvs $cvsopts -d :pserver:anonymous@cvs.sv.gnu.org:/sources/goboscripts co tools/ChrootCompile 
    cvs $cvsopts -d :pserver:anonymous@cvs.sv.gnu.org:/sources/goboscripts co tools/Compile 
    cvs $cvsopts -d :pserver:anonymous@cvs.sv.gnu.org:/sources/goboscripts co tools/Scripts 
    pushd tools/Scripts
    make
    popd
    mkdir -p Bootstrap/Scripts
    mkdir -p Bootstrap/Compile
    cp -a tools/Scripts Bootstrap/Scripts/2.1-CVS
    cp -a tools/Compile Bootstrap/Compile/1.4-CVS
    ln -nfs tools/Scripts/bin/LinkOrExpandAll .
    ln -nfs tools/ChrootCompile/ChrootCompile .
    ln -nfs tools/ChrootCompile/MiniInstallPackage .
    ln -nfs tools/ChrootCompile/MiniSymlinkProgram .
    ln -nfs tools/ChrootCompile/GenericInstall .
    mkdir -p Archives
}

function configure_tools() {
    {
       echo "chrootcompileCompileConf=$PWD/Compile.conf"
       echo "goboPrograms=/Programs"
    } > ChrootCompile.conf
    cp tools/Compile/Resources/Defaults/Settings/Compile/Compile.conf .
}

unset quiet
if [ "$1" = "--quiet" ]
then
    quiet=yes
    wgetopts="--quiet"
    cvsopts="-Q"
fi

download_packages
update_tools
configure_tools

if [ -e "./SetupAddOn" ]
then
   chmod +x SetupAddOn
   ./SetupAddOn
fi

if [ ! "$quiet" ]
then
   echo
   echo
   echo "You can now add compilation recipes to the Recipes/ directory"
   echo "and run builds with ./ChrootCompile Recipes/App/Version"
   echo
   echo
fi
