#!/bin/sh
#############################################################################
# Imports
#############################################################################
source ScriptFunctions
Import GoboLinux
Import OptionParser

#############################################################################
# Setting options
#############################################################################
scriptCredits="Copyright (C) 2006 Andre Detsch. Released under the GNU GPL."
scriptUsage="[packages_list_file]"
scriptNotes="Default package list file is "`readlink -f "$scriptPath/../Data/PackagesList"`
Add_Option_Entry "s" "start-at"    "Start at a given package from the list." ""

Parse_Options "$@"

Parse_Conf ChrootCompile.conf

if [ "$(Arg 1)" ]
then
   listfile="$(Arg 1)"
else
   listfile=`readlink -f "$scriptPath/../Data/PackagesList"`
fi

[ -f "$listfile" ] || Die "'$listfile' is not an existing file."

[ "$chrootCompileDir" ] && cd "$chrootCompileDir"

# Save stdin in fd 6
exec 6<&0

startat="$(Entry start-at)"
cat "$listfile" | while read i; do
   name=`echo $i | cut -f1 -d' '`
   version=`echo $i | cut -f2 -d' '`
   if echo "${version:0:1}" | grep -q "^#"
   then unset version
   fi
   [ "$startat" = "$name" ] && startat=
   echo "$name" | grep -q "^#" || [ "$startat" -o ! "$name" ] && continue
   [ "$name" = "exit" ] && break

   if ls Clean/i686/$name--* 2> /dev/null
   then 
      echo "Skipping $name (`ls Clean/i686/$name--*`)"
   else 
      echo "Processing $name..."
      time nice -20 ChrootCompile -l `GetRecipe $name $version` 0<&6 || { 
         echo -en "\007"; 
         Ask_Continue "Compilation of $name failed. Proceed to next program?" 0<&6 
      }
   fi
done

# Restore stdin from fd 6
exec 0<&6 6<&-
